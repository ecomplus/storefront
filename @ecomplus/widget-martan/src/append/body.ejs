<script>
  document.addEventListener("DOMContentLoaded", function (event) {
    const scriptUrl =
      "<%- options.widgetSrc || 'https://unpkg.com/@martan-app/widgets-js@1.1.5/dist/martan.umd.js' %>"
    const page = "<%- _.route.resource %>"

    const startWidget = () => {
      const color = "<%- options.settings.star_color || '#000' %>"
      const fontSize = "<%- options.settings.font_size || 18 %>"

      const storeId = "<%- options.martanStoreId %>"
      const widgetKey = "<%- options.martanWidgetKey %>"
      const webId = "<%- options.martanWebId %>"

      const $reviewsTarget =
        "<%- options.martanReviewsTarget || 'reviews_widget' %>"
      const $questionsTarget =
        "<%- options.martanQuestionsTarget || 'martan_questions_widget' %>"

      const reviewsIsEnabled = "<%- options.showWidgetReviews %>"
      const questionsIsEnabled = "<%- options.showWidgetQuestions %>"

      const martan = new window.Martan({
        storeId: parseInt(storeId, 10),
        widgetKey,
        webId,
      })

      setTimeout(() => {
        try {
          martan
            .average({
              fontSize,
              color,
            })
            .start()
        } catch (error) {}
      }, 500)

      let retrys = 0
      function loadWidgetForReviews() {
        if (document.getElementById($reviewsTarget) && martan) {
          try {
            martan.reviews($reviewsTarget).start()
          } catch (error) {
            console.error("Can't setup review widget: ", error)
          }
        } else {
          if (retrys <= 3) {
            setTimeout(() => loadWidgetForReviews(), 100)
          }
        }

        return
      }

      if (page === "products") {
        loadWidgetForReviews()
        window.goToReviews = function () {
          const $reviewsDiv = document.getElementById(
            "<%- options.martanReviewsTarget || 'reviews_widget' %>"
          ).offsetTop
          window.scrollTo({ top: $reviewsDiv - 100, behavior: "smooth" })
        }
      }
    }

    const script = document.createElement("script")
    script.setAttribute("src", scriptUrl)
    script.setAttribute("id", "martan-scripts")
    script.async = true
    document.body.appendChild(script)
    script.onload = startWidget
  })
</script>
